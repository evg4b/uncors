name: "Cookie Handling"
description: "Test cookie setting and forwarding"

backend:
  endpoints:
    - path: /api/set-cookie
      method: GET
      response:
        status: 200
        headers:
          Content-Type: application/json
          Set-Cookie: session_id=abc123; Path=/; HttpOnly
        body: '{"message":"cookie set"}'

    - path: /api/set-multiple-cookies
      method: GET
      response:
        status: 200
        headers:
          Content-Type: application/json
          Set-Cookie: user_token=xyz789; Path=/; Secure
        body: '{"message":"multiple cookies set"}'

    - path: /api/read-cookie
      method: GET
      response:
        status: 200
        headers:
          Content-Type: application/json
        body: '{"received":"cookie"}'

    - path: /api/auth
      method: POST
      response:
        status: 201
        headers:
          Content-Type: application/json
          Set-Cookie: auth_token=secure123; Path=/; HttpOnly; Secure; SameSite=Strict
        body: '{"authenticated":true}'

    - path: /api/profile
      method: GET
      response:
        status: 200
        headers:
          Content-Type: application/json
        body: '{"user":"authenticated"}'

uncors:
  http-port: 3015
  mappings:
    - from: http://test.local:3015
      to: "{{backend}}"

tests:
  - name: "Set-Cookie header is forwarded from backend"
    requests:
      - method: GET
        url: http://test.local:3015/api/set-cookie
        headers:
          Host: test.local:3015
          User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
          Accept: application/json, text/plain, */*
          Accept-Encoding: gzip, deflate, br, zstd
          Accept-Language: en-US,en;q=0.9
          Connection: keep-alive
          Referer: http://test.local:3015/
          sec-ch-ua: '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"'
          sec-ch-ua-mobile: "?0"
          sec-ch-ua-platform: '"macOS"'
          Sec-Fetch-Dest: empty
          Sec-Fetch-Mode: cors
          Sec-Fetch-Site: same-origin
          X-Requested-With: XMLHttpRequest
    expected:
      status: 200
      headers-exist:
        - Set-Cookie
      body-json:
        message: "cookie set"

  - name: "Multiple Set-Cookie headers are forwarded"
    requests:
      - method: GET
        url: http://test.local:3015/api/set-multiple-cookies
        headers:
          Host: test.local:3015
          User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
          Accept: application/json
          Accept-Encoding: gzip, deflate, br, zstd
          Accept-Language: en-US,en;q=0.9
          Connection: keep-alive
          Referer: http://test.local:3015/settings
          sec-ch-ua: '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"'
          sec-ch-ua-mobile: "?0"
          sec-ch-ua-platform: '"Windows"'
          Sec-Fetch-Dest: empty
          Sec-Fetch-Mode: cors
          Sec-Fetch-Site: same-origin
          Cache-Control: no-cache
          Pragma: no-cache
          X-Requested-With: XMLHttpRequest
    expected:
      status: 200
      body-json:
        message: "multiple cookies set"

  - name: "Cookie header is forwarded to backend"
    requests:
      - method: GET
        url: http://test.local:3015/api/read-cookie
        headers:
          Host: test.local:3015
          User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/121.0
          Accept: application/json
          Accept-Encoding: gzip, deflate, br, zstd
          Accept-Language: en-US,en;q=0.9
          Connection: keep-alive
          Cookie: session_id=test123; user_pref=light
          Referer: http://test.local:3015/dashboard
          Sec-Fetch-Dest: empty
          Sec-Fetch-Mode: cors
          Sec-Fetch-Site: same-origin
          TE: trailers
          DNT: "1"
    expected:
      status: 200
      body-json:
        received: "cookie"

  - name: "Authentication flow with secure cookie"
    requests:
      - method: POST
        url: http://test.local:3015/api/auth
        headers:
          Host: test.local:3015
          User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1
          Accept: application/json, text/plain, */*
          Accept-Encoding: gzip, deflate
          Accept-Language: en-US
          Content-Type: application/json; charset=utf-8
          Content-Length: "46"
          Origin: http://test.local:3015
          Referer: http://test.local:3015/login
          Connection: keep-alive
        body: '{"username":"testuser","password":"testpass"}'
    expected:
      status: 201
      headers-exist:
        - Set-Cookie
      body-json:
        authenticated: true

  - name: "Request with cookie after authentication"
    requests:
      - method: GET
        url: http://test.local:3015/api/profile
        headers:
          Host: test.local:3015
          User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15
          Accept: application/json, text/plain, */*
          Accept-Encoding: gzip, deflate
          Accept-Language: en-US,en;q=0.9
          Connection: keep-alive
          Cookie: auth_token=secure123
          Referer: http://test.local:3015/profile
          Sec-Fetch-Dest: empty
          Sec-Fetch-Mode: cors
          Sec-Fetch-Site: same-origin
    expected:
      status: 200
      body-json:
        user: "authenticated"
