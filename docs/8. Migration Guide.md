# Migration Guide

This guide helps you migrate your UNCORS configuration files to the latest version. Breaking changes are documented here with examples showing how to update your configuration.

## Version 0.5.x to 0.6.x

### Port Configuration Changes

**Breaking Change:** Global `http-port` and `https-port` configuration properties have been removed. Ports are now specified directly in the mapping URLs.

#### Why This Change?

The previous architecture required all HTTP mappings to share the same port and all HTTPS mappings to share the same port. The new per-mapping port configuration allows each mapping to listen on its own port, providing greater flexibility for complex development setups.

#### Migration Steps

**Old Configuration (v0.5.x and earlier):**

```yaml
http-port: 8080
https-port: 8443
mappings:
  - from: http://localhost
    to: https://api.example.com
  - from: https://secure-app
    to: https://backend.example.com
```

**New Configuration (v0.6.x):**

```yaml
mappings:
  - from: http://localhost:8080
    to: https://api.example.com
  - from: https://secure-app:8443
    to: https://backend.example.com
```

**Key Changes:**

1. **Remove** the global `http-port` and `https-port` properties
2. **Add** the port number directly to the `from` URL using the format `protocol://host:port`
3. If no port is specified, defaults are used (80 for HTTP, 443 for HTTPS)

#### Multiple Ports Support

The new architecture enables each mapping to use a different port:

```yaml
mappings:
  - from: http://api.local:3000
    to: https://api.example.com
  - from: http://admin.local:4000
    to: https://admin.example.com
  - from: https://secure.local:8443
    to: https://backend.example.com
```

This configuration starts three separate servers:
- HTTP server on port 3000 for `api.local`
- HTTP server on port 4000 for `admin.local`
- HTTPS server on port 8443 for `secure.local`

#### Using Default Ports

If you want to use the default ports (80 for HTTP, 443 for HTTPS), you can omit the port number:

```yaml
mappings:
  - from: http://localhost
    to: https://api.example.com
  - from: https://secure-app
    to: https://backend.example.com
```

#### Short Syntax Migration

**Old Configuration:**

```yaml
http-port: 8080
mappings:
  - http://localhost: https://github.com
```

**New Configuration:**

```yaml
mappings:
  - http://localhost:8080: https://github.com
```

#### Command-Line Arguments Migration

**Old CLI Usage:**

```bash
uncors --http-port 8080 --from http://localhost --to https://api.example.com
```

**New CLI Usage:**

```bash
uncors --from http://localhost:8080 --to https://api.example.com
```

#### Wildcard Mapping Migration

**Old Configuration:**

```yaml
http-port: 8080
mappings:
  - from: http://*.local.com
    to: https://*.example.com
```

**New Configuration:**

```yaml
mappings:
  - from: http://*.local.com:8080
    to: https://*.example.com
```

#### Complex Configuration Example

Here's a complete example showing migration of a complex configuration:

**Before:**

```yaml
debug: true
http-port: 8080
https-port: 8443
proxy: http://proxy.example.com:3128
cert-file: ~/certs/server.crt
key-file: ~/certs/server.key

mappings:
  - from: http://api.local
    to: https://api.example.com
    mocks:
      - path: /test
        response:
          code: 200
          raw-content: "Test response"
  - from: https://secure.local
    to: https://secure.example.com
    statics:
      - path: /static
        dir: ./public
```

**After:**

```yaml
debug: true
proxy: http://proxy.example.com:3128
cert-file: ~/certs/server.crt
key-file: ~/certs/server.key

mappings:
  - from: http://api.local:8080
    to: https://api.example.com
    mocks:
      - path: /test
        response:
          code: 200
          raw-content: "Test response"
  - from: https://secure.local:8443
    to: https://secure.example.com
    statics:
      - path: /static
        dir: ./public
```

#### Schema Validation

If you're using JSON Schema validation in your IDE, the schema will automatically detect and flag the old `http-port` and `https-port` properties as errors, helping you identify configurations that need to be migrated.

**Error Example:**

```yaml
http-port: 8080  # Error: Additional property http-port is not allowed
mappings:
  - from: http://localhost
    to: https://github.com
```

#### Troubleshooting

**Problem:** UNCORS fails to start with "Additional property" error

**Solution:** Remove `http-port` and `https-port` from your configuration file and add ports directly to the `from` URLs in your mappings.

---

**Problem:** My application can't connect to the old port

**Solution:** Update the port in your application's configuration to match the port specified in the `from` URL. For example, if you changed from `http-port: 8080` with `from: http://localhost` to `from: http://localhost:3000`, update your application to connect to `http://localhost:3000`.

---

**Problem:** I need multiple mappings on the same port

**Solution:** You can have multiple mappings on the same port by specifying the same port number in different `from` URLs:

```yaml
mappings:
  - from: http://api.local:8080
    to: https://api.example.com
  - from: http://admin.local:8080
    to: https://admin.example.com
```

Both `api.local` and `admin.local` will be served on port 8080.

## Need Help?

If you encounter issues during migration or have questions:

1. Check the [Configuration](./2.-Configuration) documentation for detailed information about the new configuration format
2. Review the [JSON Schema](https://raw.githubusercontent.com/evg4b/uncors/main/schema.json) for configuration validation
3. Report issues at [GitHub Issues](https://github.com/evg4b/uncors/issues)
